<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>mybatis工作原理 | frozeNwInd</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">mybatis工作原理</h1><a id="logo" href="/.">frozeNwInd</a><p class="description">吕乘风的博客</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/history/"><i class="fa fa-history"> 历史</i></a><a href="/MoonAndStar/"><i class="fa fa-heart"> MoonAndStar</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">mybatis工作原理</h1><div class="post-meta">2019-11-14<span> | </span><span class="category"><a href="/categories/technology/">technology</a></span></div><a class="disqus-comment-count" href="/2019/11/14/mybatis%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/#vcomment"><span class="valine-comment-count" data-xid="/2019/11/14/mybatis%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/"></span><span> 条评论</span></a><div class="post-content"><h3 id="mybatis工作原理"><a href="#mybatis工作原理" class="headerlink" title="mybatis工作原理"></a>mybatis工作原理</h3><p>在MyBatis运行开始时需要先通过Resources加载全局配置文件。<br>下面需要实例化SqlSessionFactoryBuilder构建器。<br>帮助SqlSessionFactory接口实现类DefaultSqlSessionFactory。<br>在实例化DefaultSqlSessionFactory之前需要先创建XmlConfigBuilder解析全局配置文件流,并把解析结果存放在Configuration中。<br>之后把Configuratin传递给DefaultSqlSessionFactory。<br>到此SqlSessionFactory工厂创建成功。<br>由SqlSessionFactory工厂创建SqlSession。<br>每次创建SqlSession时,都需要由TransactionFactory创建Transaction对象,同时还需要创建SqlSession的执行器Excutor,最后实例化DefaultSqlSession,传递给SqlSession接口。<br>根据项目需求使用SqlSession接口中的API完成具体的事务操作。如果事务执行失败,需要进行rollback回滚事务；如果事务执行成功提交给数据库，关闭SqlSession。<br>到此就是MyBatis的运行原理.</p>
<ol>
<li>读取核心配置文件，并返回InputStream流对象</li>
<li>根据InputStream流对象解析出Configuration对象，然后创建SqlSessionFactory工厂对象</li>
<li>根据一系列属性从SqlSessionFactory工厂中创建SqlSession</li>
<li>从SqlSession中调用Executor执行数据库操作，生成具体SQL指令</li>
<li>对执行结果进行二次封装</li>
<li>提交与事务</li>
</ol>
<h3 id="1-读取核心配置文件"><a href="#1-读取核心配置文件" class="headerlink" title="1.读取核心配置文件"></a>1.读取核心配置文件</h3><h4 id="1-1-配置文件mybatis-config-xml"><a href="#1-1-配置文件mybatis-config-xml" class="headerlink" title="1.1 配置文件mybatis-config.xml"></a>1.1 配置文件mybatis-config.xml</h4><h4 id="1-2-Mapper-xml"><a href="#1-2-Mapper-xml" class="headerlink" title="1.2 ****Mapper.xml"></a>1.2 ****Mapper.xml</h4><h3 id="2-根据配置文件生成SqlSessionFactory工厂对象"><a href="#2-根据配置文件生成SqlSessionFactory工厂对象" class="headerlink" title="2.根据配置文件生成SqlSessionFactory工厂对象"></a>2.根据配置文件生成SqlSessionFactory工厂对象</h3><h4 id="2-1-Resources-getResourceAsStream-resource-源码分析"><a href="#2-1-Resources-getResourceAsStream-resource-源码分析" class="headerlink" title="2.1 Resources.getResourceAsStream(resource)源码分析"></a>2.1 Resources.getResourceAsStream(resource)源码分析</h4><p>Resources是mybatis提供的一个加载资源文件的工具类。<br><img src="/resources.jpg"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public static InputStream getResourceAsStream(String resource) throws IOException &#123;</span><br><span class="line">    return getResourceAsStream((ClassLoader)null, resource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getResourceAsStream调用下面的方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public static InputStream getResourceAsStream(ClassLoader loader, String resource) throws IOException &#123;</span><br><span class="line">    InputStream in = classLoaderWrapper.getResourceAsStream(resource, loader);</span><br><span class="line">    if (in == null) &#123;</span><br><span class="line">        throw new IOException(&quot;Could not find resource &quot; + resource);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return in;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取到自身的ClassLoader对象，然后交给ClassLoader(lang包下的类加载器)来加载：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">InputStream getResourceAsStream(String resource, ClassLoader[] classLoader) &#123;</span><br><span class="line">    ClassLoader[] arr$ = classLoader;</span><br><span class="line">    int len$ = classLoader.length;</span><br><span class="line"></span><br><span class="line">    for(int i$ = 0; i$ &lt; len$; ++i$) &#123;</span><br><span class="line">        ClassLoader cl = arr$[i$];</span><br><span class="line">        if (null != cl) &#123;</span><br><span class="line">            InputStream returnValue = cl.getResourceAsStream(resource);</span><br><span class="line">            if (null == returnValue) &#123;</span><br><span class="line">                returnValue = cl.getResourceAsStream(&quot;/&quot; + resource);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (null != returnValue) &#123;</span><br><span class="line">                return returnValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>返回了一个InputStream对象。</p>
<h4 id="2-2-new-SqlSessionFactoryBuilder-build-inputStream-源码分析"><a href="#2-2-new-SqlSessionFactoryBuilder-build-inputStream-源码分析" class="headerlink" title="2.2 new SqlSessionFactoryBuilder().build(inputStream)源码分析"></a>2.2 new SqlSessionFactoryBuilder().build(inputStream)源码分析</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public SqlSessionFactoryBuilder() &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以new SqlSessionFactoryBuilder()只是创建一个对象实例，而没有对象返回(建造者模式)，对象的返回交给build()方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public SqlSessionFactory build(InputStream inputStream) &#123;</span><br><span class="line">    return this.build((InputStream)inputStream, (String)null, (Properties)null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里要传入一个InputStream对象，就是将上一步获取到的InputStream对象传入。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public SqlSessionFactory build(InputStream inputStream, String environment, Properties properties) &#123;</span><br><span class="line">    SqlSessionFactory var5;</span><br><span class="line">    try &#123;</span><br><span class="line">        // 进行XML配置文件的解析</span><br><span class="line">        XMLConfigBuilder parser = new XMLConfigBuilder(inputStream, environment, properties);</span><br><span class="line">        var5 = this.build(parser.parse());</span><br><span class="line">    &#125; catch (Exception var14) &#123;</span><br><span class="line">        throw ExceptionFactory.wrapException(&quot;Error building SqlSession.&quot;, var14);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        ErrorContext.instance().reset();</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            inputStream.close();</span><br><span class="line">        &#125; catch (IOException var13) &#123;</span><br><span class="line">            ;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return var5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过Document对象来解析，然后返回InputStream对象，然后交给XMLConfigBuilder构造成org.apache.ibatis.session.Configuration对象，然后交给build()方法构造程SqlSessionFactory：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public SqlSessionFactory build(Configuration config) &#123;</span><br><span class="line">    return new DefaultSqlSessionFactory(config);</span><br><span class="line">&#125;</span><br><span class="line">public DefaultSqlSessionFactory(Configuration configuration) &#123;</span><br><span class="line">    this.configuration = configuration;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-创建SqlSession"><a href="#3-创建SqlSession" class="headerlink" title="3.创建SqlSession"></a>3.创建SqlSession</h3><p>SqlSession完全包含了面向数据库执行SQL命令所需的所有方法。可以通过SqlSession实例来直接执行已映射的SQL语句。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public SqlSession openSession() &#123;</span><br><span class="line">    return this.openSessionFromDataSource(this.configuration.getDefaultExecutorType(), (TransactionIsolationLevel)null, false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用自身的openSessionFromDataSource方法：</p>
<ol>
<li>getDefaultExecutorType()默认是SIMPLE。</li>
<li>注意TX等级是null，autoCommit是false。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">private SqlSession openSessionFromDataSource(ExecutorType execType, TransactionIsolationLevel level, boolean autoCommit) &#123;</span><br><span class="line">    Transaction tx = null;</span><br><span class="line"></span><br><span class="line">    DefaultSqlSession var8;</span><br><span class="line">    try &#123;</span><br><span class="line">        Environment environment = this.configuration.getEnvironment();</span><br><span class="line">        // 根据Configuration的Environment属性来创建事务工厂</span><br><span class="line">        TransactionFactory transactionFactory = this.getTransactionFactoryFromEnvironment(environment);</span><br><span class="line">        // 从事务工厂中创建事务，默认等级为null，autoCommit=false</span><br><span class="line">        tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);</span><br><span class="line">        // 创建执行器</span><br><span class="line">        Executor executor = this.configuration.newExecutor(tx, execType);</span><br><span class="line">        // 根据执行器创建返回对象 SqlSession</span><br><span class="line">        var8 = new DefaultSqlSession(this.configuration, executor, autoCommit);</span><br><span class="line">    &#125; catch (Exception var12) &#123;</span><br><span class="line">        this.closeTransaction(tx);</span><br><span class="line">        throw ExceptionFactory.wrapException(&quot;Error opening session.  Cause: &quot; + var12, var12);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">    return var8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>构建步骤：Environment&gt;&gt;TransactionFactory+autoCommit+tx-level&gt;&gt;Transaction+ExecType&gt;&gt;Executor+Configuration+autoCommit&gt;&gt;SqlSession。<br>其中，Environment是Configuration中的属性。</p>
<h3 id="4-调用Executor执行数据库操作-amp-amp-生成具体SQL指令"><a href="#4-调用Executor执行数据库操作-amp-amp-生成具体SQL指令" class="headerlink" title="4.调用Executor执行数据库操作&amp;&amp;生成具体SQL指令"></a>4.调用Executor执行数据库操作&amp;&amp;生成具体SQL指令</h3><p>在拿到SqlSession对象后，我们调用它的insert方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public int insert(String statement, Object parameter) &#123;</span><br><span class="line">    return this.update(statement, parameter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它调用了自身的update(statement, parameter)方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public int update(String statement, Object parameter) &#123;</span><br><span class="line">    int var4;</span><br><span class="line">    try &#123;</span><br><span class="line">        this.dirty = true;</span><br><span class="line">        MappedStatement ms = this.configuration.getMappedStatement(statement);</span><br><span class="line">        // wrapCollection(parameter)判断 param对象是否是集合</span><br><span class="line">        var4 = this.executor.update(ms, this.wrapCollection(parameter));</span><br><span class="line">    &#125; catch (Exception var8) &#123;</span><br><span class="line">        throw ExceptionFactory.wrapException(&quot;Error updating database.  Cause: &quot; + var8, var8);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">    return var4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mappedStatements就是我们平时说的sql映射对象。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protected final Map&lt;String, MappedStatement&gt; mappedStatements;</span><br></pre></td></tr></table></figure>
<p>可见它是一个Map集合，在我们加载xml配置的时候，mapping.xml的namespace和id信息就会存放为mappedStatements的key，对应的SQL语句就是value。</p>
<p>然后调用BaseExecutor中的update()方法:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public int update(MappedStatement ms, Object parameter) throws SQLException &#123;</span><br><span class="line">    ErrorContext.instance().resource(ms.getResource()).activity(&quot;executing an update&quot;).object(ms.getId());</span><br><span class="line">    if (this.closed) &#123;</span><br><span class="line">        throw new ExecutorException(&quot;Executor was closed.&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        this.clearLocalCache();</span><br><span class="line">        // 真正做执行操作的方法</span><br><span class="line">        return this.doUpdate(ms, parameter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>doUpdate()才是真正做执行操作的方法:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public int doUpdate(MappedStatement ms, Object parameter) throws SQLException &#123;</span><br><span class="line">    Statement stmt = null;</span><br><span class="line">    int var6;</span><br><span class="line">    try &#123;</span><br><span class="line">        Configuration configuration = ms.getConfiguration();</span><br><span class="line">        // 创建StatementHandler对象，从而创建Statement对象</span><br><span class="line">        StatementHandler handler = configuration.newStatementHandler(this, ms, parameter, RowBounds.DEFAULT, (ResultHandler)null, (BoundSql)null);</span><br><span class="line">        // 将sql语句和参数绑定并生成SQL指令</span><br><span class="line">        stmt = this.prepareStatement(handler, ms.getStatementLog());</span><br><span class="line">        var6 = handler.update(stmt);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        this.closeStatement(stmt);</span><br><span class="line">    &#125;</span><br><span class="line">    return var6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看看prepareStatement()方法，看mybatis是如何将sql拼接合成的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">private Statement prepareStatement(StatementHandler handler, Log statementLog) throws SQLException &#123;</span><br><span class="line">    Connection connection = this.getConnection(statementLog);</span><br><span class="line">    // 准备Statement</span><br><span class="line">    Statement stmt = handler.prepare(connection);</span><br><span class="line">    // 设置SQL查询中的参数值</span><br><span class="line">    handler.parameterize(stmt);</span><br><span class="line">    return stmt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看parameterize()方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void parameterize(Statement statement) throws SQLException &#123;</span><br><span class="line">    this.parameterHandler.setParameters((PreparedStatement)statement);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里把statement转换成PreparedStatement对象，它比Statement更快更安全。<br>这些都是JDBC中的对象，由此也能看出，mybatis是对JDBC的封装。</p>
<p>从ParameterMapping中读取参数值和类型，然后设置到SQL语句中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public void setParameters(PreparedStatement ps) &#123;</span><br><span class="line">    ErrorContext.instance().activity(&quot;setting parameters&quot;).object(this.mappedStatement.getParameterMap().getId());</span><br><span class="line">    List&lt;ParameterMapping&gt; parameterMappings = this.boundSql.getParameterMappings();</span><br><span class="line">    if (parameterMappings != null) &#123;</span><br><span class="line">        for(int i = 0; i &lt; parameterMappings.size(); ++i) &#123;</span><br><span class="line">            ParameterMapping parameterMapping = (ParameterMapping)parameterMappings.get(i);</span><br><span class="line">            if (parameterMapping.getMode() != ParameterMode.OUT) &#123;</span><br><span class="line">                String propertyName = parameterMapping.getProperty();</span><br><span class="line">                Object value;</span><br><span class="line">                if (this.boundSql.hasAdditionalParameter(propertyName)) &#123;</span><br><span class="line">                    value = this.boundSql.getAdditionalParameter(propertyName);</span><br><span class="line">                &#125; else if (this.parameterObject == null) &#123;</span><br><span class="line">                    value = null;</span><br><span class="line">                &#125; else if (this.typeHandlerRegistry.hasTypeHandler(this.parameterObject.getClass())) &#123;</span><br><span class="line">                    value = this.parameterObject;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    MetaObject metaObject = this.configuration.newMetaObject(this.parameterObject);</span><br><span class="line">                    value = metaObject.getValue(propertyName);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                TypeHandler typeHandler = parameterMapping.getTypeHandler();</span><br><span class="line">                JdbcType jdbcType = parameterMapping.getJdbcType();</span><br><span class="line">                if (value == null &amp;&amp; jdbcType == null) &#123;</span><br><span class="line">                    jdbcType = this.configuration.getJdbcTypeForNull();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                try &#123;</span><br><span class="line">                    typeHandler.setParameter(ps, i + 1, value, jdbcType);</span><br><span class="line">                &#125; catch (TypeException var10) &#123;</span><br><span class="line">                    throw new TypeException(&quot;Could not set parameters for mapping: &quot; + parameterMapping + &quot;. Cause: &quot; + var10, var10);</span><br><span class="line">                &#125; catch (SQLException var11) &#123;</span><br><span class="line">                    throw new TypeException(&quot;Could not set parameters for mapping: &quot; + parameterMapping + &quot;. Cause: &quot; + var11, var11);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-对查询结果二次封装"><a href="#5-对查询结果二次封装" class="headerlink" title="5.对查询结果二次封装"></a>5.对查询结果二次封装</h3><p>在doUpdate()方法中，解析生成完新的SQL后，然后执行var6=handler.update(stmt)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public int update(Statement statement) throws SQLException &#123;</span><br><span class="line">    PreparedStatement ps = (PreparedStatement)statement;</span><br><span class="line">     // 执行sql</span><br><span class="line">    ps.execute();</span><br><span class="line">    // 获取返回值</span><br><span class="line">    int rows = ps.getUpdateCount();</span><br><span class="line">    Object parameterObject = this.boundSql.getParameterObject();</span><br><span class="line">    KeyGenerator keyGenerator = this.mappedStatement.getKeyGenerator();</span><br><span class="line">    keyGenerator.processAfter(this.executor, this.mappedStatement, ps, parameterObject);</span><br><span class="line">    return rows;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为开头是一个insert操作，返回的是一个int类型的值，所以这里mybatis给我们直接返回int。<br>如果是query操作，返回的是一个ResultSet，mybatis将查询结果包装成ResultSetWrapper类型，然后一步步对应java类型赋值等。</p>
<h3 id="6-提交与事务"><a href="#6-提交与事务" class="headerlink" title="6.提交与事务"></a>6.提交与事务</h3><p>commit()方法的源码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void commit() &#123;</span><br><span class="line">    this.commit(false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用其对象本身的commit()方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public void commit(boolean force) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        // 是否提交（判断是提交还是回滚）</span><br><span class="line">        this.executor.commit(this.isCommitOrRollbackRequired(force));</span><br><span class="line">        this.dirty = false;</span><br><span class="line">    &#125; catch (Exception var6) &#123;</span><br><span class="line">        throw ExceptionFactory.wrapException(&quot;Error committing transaction.  Cause: &quot; + var6, var6);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果dirty是false，则进行回滚；如果是true，则正常提交。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">private boolean isCommitOrRollbackRequired(boolean force) &#123;</span><br><span class="line">    return !this.autoCommit &amp;&amp; this.dirty || force;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用CachingExecutor的commit()方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public void commit(boolean required) throws SQLException &#123;</span><br><span class="line">    this.delegate.commit(required);</span><br><span class="line">    this.tcm.commit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用BaseExecutor的commit()方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public void commit(boolean required) throws SQLException &#123;</span><br><span class="line">    if (this.closed) &#123;</span><br><span class="line">        throw new ExecutorException(&quot;Cannot commit, transaction is already closed&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        this.clearLocalCache();</span><br><span class="line">        this.flushStatements();</span><br><span class="line">        if (required) &#123;</span><br><span class="line">            this.transaction.commit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用JDBCTransaction的commit()方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public void commit() throws SQLException &#123;</span><br><span class="line">    if (this.connection != null &amp;&amp; !this.connection.getAutoCommit()) &#123;</span><br><span class="line">        if (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(&quot;Committing JDBC Connection [&quot; + this.connection + &quot;]&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        // 提交连接</span><br><span class="line">        this.connection.commit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tags"><a href="/tags/mybatis/"><i class="fa fa-tag"></i>mybatis</a></div><div class="post-nav"><a class="pre" href="/2019/11/14/mybatis%E7%9B%B8%E5%85%B3%E6%80%BB%E7%BB%93/">mybatis相关总结</a><a class="next" href="/2019/11/08/java%E5%B9%B6%E5%8F%91%E2%80%94%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/">java并发—并发容器</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == 'true' ? true : false;
var verify = 'false' == 'true' ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'NPvQJfh7XNHqMqbmVYOg5VE5-9Nh9j0Va',
  appKey:'hgOdKtBYlsJzigDKoXqevrSI',
  placeholder:'我想听你说一句… （留言请填写您的昵称和邮箱，方便回复以邮件形式通知您）',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://blog.frozenwind.online"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/emotion/">emotion</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/technology/">technology</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 15px;">随笔</a> <a href="/tags/dubbo/" style="font-size: 15px;">dubbo</a> <a href="/tags/java%E5%9F%BA%E7%A1%80/" style="font-size: 15px;">java基础</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 15px;">并发</a> <a href="/tags/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/" style="font-size: 15px;">秒杀系统</a> <a href="/tags/mybatis/" style="font-size: 15px;">mybatis</a> <a href="/tags/java-web/" style="font-size: 15px;">java web</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/markdown/" style="font-size: 15px;">markdown</a> <a href="/tags/%E4%B8%80%E8%A8%80/" style="font-size: 15px;">一言</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 15px;">计算机网络</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" style="font-size: 15px;">数据结构与算法</a> <a href="/tags/%E6%83%85%E4%B9%A6/" style="font-size: 15px;">情书</a> <a href="/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 15px;">微信小程序</a> <a href="/tags/%E8%AF%8D/" style="font-size: 15px;">词</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 15px;">操作系统</a> <a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 15px;">消息队列</a> <a href="/tags/java%E8%99%9A%E6%8B%9F%E6%9C%BA/" style="font-size: 15px;">java虚拟机</a> <a href="/tags/%E7%B3%BB%E7%BB%9F%E9%97%AE%E9%A2%98/" style="font-size: 15px;">系统问题</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/11/24/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/">微信小程序开发记录—爱河</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/22/mysql%E7%B4%A2%E5%BC%95%E7%9B%B8%E5%85%B3%E6%80%BB%E7%BB%93/">mysql索引相关总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/14/mybatis%E7%9B%B8%E5%85%B3%E6%80%BB%E7%BB%93/">mybatis相关总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/14/mybatis%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/">mybatis工作原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/08/java%E5%B9%B6%E5%8F%91%E2%80%94%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8/">java并发—并发容器</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/08/java8%E2%80%94%E6%8E%A5%E5%8F%A3%E4%B8%AD%E7%9A%84%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95%E5%92%8C%E9%BB%98%E8%AE%A4%E6%96%B9%E6%B3%95/">java8—接口中的静态方法和默认方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/07/java8%E2%80%94Stream-API/">java8—Stream API</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/07/java8%E2%80%94%E6%96%B9%E6%B3%95%E5%BC%95%E7%94%A8%E4%B8%8E%E6%9E%84%E9%80%A0%E5%99%A8%E5%BC%95%E7%94%A8/">java8—方法引用与构造器引用</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/07/java8-%E5%9B%9B%E5%A4%A7%E5%86%85%E7%BD%AE%E6%A0%B8%E5%BF%83%E5%87%BD%E6%95%B0%E5%BC%8F%E6%8E%A5%E5%8F%A3%E8%AF%A6%E8%A7%A3/">java8—四大内置核心函数式接口详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/07/java8%E2%80%94Lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/">java8—Lambda表达式</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://blog.scarboroughcoral.top/" title="scarboroughcoral" target="_blank">scarboroughcoral</a><ul></ul><a href="http://blog.wangxuyao.club/" title="冰冰冰淇淋君icecream" target="_blank">冰冰冰淇淋君icecream</a><ul></ul><a target="_blank"></a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">frozeNwInd.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>